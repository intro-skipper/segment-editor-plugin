import{c as O,x as L,ac as z}from"./index-RpOviJkQ.js";import{a as y}from"./tanstack-vendor-DcxxohBG.js";import{p as q,o as I,f as H}from"./media-vendor-CUSAIUeh.js";import{L as w,f as R}from"./feature-error-boundary-BEcF-gHJ.js";class j{scaleDown(t){const e=this.getWidth(),s=this.getHeight();let i=1;if(t.maxDimension>0){const n=Math.max(e,s);n>t.maxDimension&&(i=t.maxDimension/n)}else i=1/t.quality;i<1&&this.resize(e*i,s*i,i)}}function V(r){const t=new URL(r,location.href);return t.protocol===location.protocol&&t.host===location.host&&t.port===location.port}function S(r,t){const e=new URL(r),s=new URL(t);return e.protocol===s.protocol&&e.hostname===s.hostname&&e.port===s.port}class F extends j{_getCanvas(){if(!this._canvas)throw new Error("Canvas is not initialized");return this._canvas}_getContext(){if(!this._context)throw new Error("Context is not initialized");return this._context}_getWidth(){if(!this._width)throw new Error("Width is not initialized");return this._width}_getHeight(){if(!this._height)throw new Error("Height is not initialized");return this._height}_initCanvas(){const t=this.image;if(!t)throw new Error("Image is not initialized");const e=this._canvas=document.createElement("canvas"),s=e.getContext("2d");if(!s)throw new ReferenceError("Failed to create canvas context");this._context=s,e.className="@vibrant/canvas",e.style.display="none",this._width=e.width=t.width,this._height=e.height=t.height,s.drawImage(t,0,0),document.body.appendChild(e)}load(t){let e,s;if(typeof t=="string")e=document.createElement("img"),s=t,!V(s)&&!S(window.location.href,s)&&(e.crossOrigin="anonymous"),e.src=s;else if(t instanceof HTMLImageElement)e=t,s=t.src;else return Promise.reject(new Error("Cannot load buffer as an image in browser"));return this.image=e,new Promise((i,n)=>{const o=()=>{this._initCanvas(),i(this)};e.complete?o():(e.onload=o,e.onerror=a=>n(new Error(`Fail to load image: ${s}`)))})}clear(){this._getContext().clearRect(0,0,this._getWidth(),this._getHeight())}update(t){this._getContext().putImageData(t,0,0)}getWidth(){return this._getWidth()}getHeight(){return this._getHeight()}resize(t,e,s){if(!this.image)throw new Error("Image is not initialized");this._width=this._getCanvas().width=t,this._height=this._getCanvas().height=e,this._getContext().scale(s,s),this._getContext().drawImage(this.image,0,0)}getPixelCount(){return this._getWidth()*this._getHeight()}getImageData(){return this._getContext().getImageData(0,0,this._getWidth(),this._getHeight())}remove(){this._canvas&&this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas)}}function v(r,t){const e={};for(const s in r)if(r.hasOwnProperty(s)){const i=r[s];if(!i)continue;e[s]=t(i)}return e}function l(r,...t){return t.forEach(e=>{if(e){for(const s in e)if(e.hasOwnProperty(s)){const i=e[s];Array.isArray(i)?r[s]=i.slice(0):typeof i=="object"?(r[s]||(r[s]={}),l(r[s],i)):r[s]=i}}}),r}function N(r,t){const{colorCount:e,quantizer:s,generators:i,filters:n}=r,o={colorCount:e},a=typeof s=="string"?{name:s,options:{}}:s;return a.options=l({},o,a.options),l({},{quantizer:a,generators:i,filters:n},t)}class A{constructor(t,e={}){this._src=t,this._opts=l({},c.DefaultOpts,e)}maxColorCount(t){return this._opts.colorCount=t,this}maxDimension(t){return this._opts.maxDimension=t,this}addFilter(t){return this._opts.filters?this._opts.filters.push(t):this._opts.filters=[t],this}removeFilter(t){if(this._opts.filters){const e=this._opts.filters.indexOf(t);e>0&&this._opts.filters.splice(e)}return this}clearFilters(){return this._opts.filters=[],this}quality(t){return this._opts.quality=t,this}useImageClass(t){return this._opts.ImageClass=t,this}useGenerator(t,e){return this._opts.generators||(this._opts.generators=[]),this._opts.generators.push(e?{name:t,options:e}:t),this}useQuantizer(t,e){return this._opts.quantizer=e?{name:t,options:e}:t,this}build(){return new c(this._src,this._opts)}getPalette(){return this.build().getPalette()}}class B{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}}function Y(){return new B}const $=5;class G{constructor(t){this.WorkerClass=t,this._taskId=0,this._workers=[],this._queue=[],this._executing={}}_findIdleWorker(){let t;return this._workers.length===0||this._workers.length<$?(t=new this.WorkerClass,t.id=this._workers.length,t.idle=!0,this._workers.push(t),t.onmessage=this._onMessage.bind(this,t.id)):t=this._workers.find(({idle:e})=>e),t}_enqueue(t,e){const s=Y(),i={id:this._taskId++,payload:t,transferList:e,deferred:s};return this._queue.push(i),this._tryDequeue(),s.promise}_tryDequeue(){if(this._queue.length<=0)return;const t=this._findIdleWorker();if(!t)return;const e=this._queue.shift();this._executing[e.id]=e;const s=e.transferList,{deferred:i,transferList:n,...o}=e;t.postMessage(o,s),t.idle=!1}_onMessage(t,e){const s=e.data;if(!s)return;const{id:i}=s,n=this._executing[i];if(!n)return;switch(delete this._executing[i],s.type){case"return":n.deferred.resolve(s.payload);break;case"error":n.deferred.reject(new Error(s.payload));break}const o=this._workers[t];o&&(o.idle=!0,this._tryDequeue())}invoke(t,e){return this._enqueue(t,e)}}class Q{constructor(){this._pools={}}register(t,e){this._pools[t]=new G(e)}hasWorker(t){return!!this._pools[t]}getWorker(t){return this._pools[t]}invokeWorker(t,e,s){return this.hasWorker(t)?this.getWorker(t).invoke(e,s):Promise.reject(`Worker '${t}' does not exist`)}}function X(r,t,e){return"#"+((1<<24)+(r<<16)+(t<<8)+e).toString(16).slice(1,7)}function J(r,t,e){r/=255,t/=255,e/=255;const s=Math.max(r,t,e),i=Math.min(r,t,e);let n=0,o=0;const a=(s+i)/2;if(s!==i){const h=s-i;switch(o=a>.5?h/(2-s-i):h/(s+i),s){case r:n=(t-e)/h+(t<e?6:0);break;case t:n=(e-r)/h+2;break;case e:n=(r-t)/h+4;break}n/=6}return[n,o,a]}class g{static applyFilters(t,e){return e.length>0?t.filter(({r:s,g:i,b:n})=>{var o;for(let a=0;a<e.length;a++)if(!((o=e[a])!=null&&o.call(e,s,i,n,255)))return!1;return!0}):t}static clone(t){return new g(t._rgb,t._population)}get r(){return this._rgb[0]}get g(){return this._rgb[1]}get b(){return this._rgb[2]}get rgb(){return this._rgb}get hsl(){if(!this._hsl){const[t,e,s]=this._rgb;this._hsl=J(t,e,s)}return this._hsl}get hex(){if(!this._hex){const[t,e,s]=this._rgb;this._hex=X(t,e,s)}return this._hex}get population(){return this._population}toJSON(){return{rgb:this.rgb,population:this.population}}getYiq(){if(!this._yiq){const t=this._rgb;this._yiq=(t[0]*299+t[1]*587+t[2]*114)/1e3}return this._yiq}get titleTextColor(){return this._titleTextColor||(this._titleTextColor=this.getYiq()<200?"#fff":"#000"),this._titleTextColor}get bodyTextColor(){return this._bodyTextColor||(this._bodyTextColor=this.getYiq()<150?"#fff":"#000"),this._bodyTextColor}constructor(t,e){this._rgb=t,this._population=e}}class K{constructor(t){this.PipelineWorker=t,this._manager=new Q,this._manager.register("pipeline",t)}_rehydrate(t){const{colors:e,palettes:s}=t;return t.colors=e.map(i=>g.clone(i)),t.palettes=v(s,i=>v(i,n=>n?g.clone(n):null)),t}async process(t,e){const s=await this._manager.invokeWorker("pipeline",[t,e],[t.data.buffer]);return this._rehydrate(s)}}const P=class m{constructor(t,e){this._src=t,this.opts=l({},m.DefaultOpts,e)}static use(t){this._pipeline=t}static from(t){return new A(t)}get result(){return this._result}_process(t,e){t.scaleDown(this.opts);const s=N(this.opts,e);return m._pipeline.process(t.getImageData(),s)}async getPalette(){const t=new this.opts.ImageClass;try{const e=await t.load(this._src),s=await this._process(e,{generators:["default"]});this._result=s;const i=s.palettes.default;if(!i)throw new Error("Something went wrong and a palette was not found, please file a bug against our GitHub repo: https://github.com/vibrant-Colors/node-vibrant/");return t.remove(),i}catch(e){return t.remove(),Promise.reject(e)}}async getPalettes(){const t=new this.opts.ImageClass;try{const e=await t.load(this._src),s=await this._process(e,{generators:["*"]});this._result=s;const i=s.palettes;return t.remove(),i}catch(e){return t.remove(),Promise.reject(e)}}};P.DefaultOpts={colorCount:64,quality:5,filters:[]};let c=P;c.DefaultOpts.quantizer="mmcq";c.DefaultOpts.generators=["default"];c.DefaultOpts.filters=["default"];c.DefaultOpts.ImageClass=F;function Z(r){return new Worker("/SegmentEditor/assets/worker.worker-B5PjTdZN.js",{name:r?.name})}let D=!1;const U=()=>{D||(c.use(new K(Z)),D=!0)},M=r=>r==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":r,tt=new w(100),et=new w(100),T=new w(100),_=new Map,x=r=>r==="dark"?et:tt;let p=null;const st=()=>{if(!p){const r=document.createElement("canvas"),t=r.getContext("2d",{willReadFrequently:!0});t&&(p={canvas:r,ctx:t})}return p},rt=(r,t)=>{const e=q(r);if(!e)return r;const s=I(e);return s.l=Math.max(0,Math.min(1,s.l+t)),H(s)},it=r=>{const t=q(r);return t?I(t).l:.5},W=(r,t=.5)=>it(r)<t?"#f5f5f5":"#1a1a1a",nt=(r,t)=>{const e=t==="dark",s=e?r.DarkMuted?.hex??r.Muted?.hex:r.LightVibrant?.hex??r.Vibrant?.hex;if(!s)return null;const i=rt(s,e?-.12:.08),n=W(i,.5),o=e?r.Muted?.hex??r.DarkMuted?.hex??s:r.Vibrant?.hex??r.DarkVibrant?.hex??s,a=e?r.LightMuted?.hex??r.Muted?.hex??s:r.DarkVibrant?.hex??r.Vibrant?.hex??s;return{background:i,primary:o,accent:a,text:n,accentText:W(a)}},ot=5e3;async function at(r,t){const e=st();return e?new Promise(s=>{const i=new Image;i.onload=async()=>{const{canvas:n,ctx:o}=e,a=Math.min(50/i.width,50/i.height,1);n.width=Math.floor(i.width*a),n.height=Math.floor(i.height*a),o.drawImage(i,0,0,n.width,n.height);try{const h=await c.from(n.toDataURL("image/jpeg",.6)).quality(1).getPalette();T.set(r,h),s(h)}catch{s(null)}},i.onerror=()=>s(null),i.crossOrigin="anonymous",i.src=t}):null}async function ht(r,t){return Promise.race([at(r,t),new Promise(e=>setTimeout(()=>e(null),ot))])}function ct(r){U();const t=T.get(r);if(t)return Promise.resolve(t);let e=_.get(r);return e||(e=R(r).then(s=>s?ht(r,s):null),_.set(r,e),e.finally(()=>_.delete(r))),e}async function E(r,t){const e=x(t),s=e.get(r);if(s)return s;const i=await ct(r);if(!i)return null;const n=nt(i,t);return n&&e.set(r,n),n}function dt(r){const t=O.c(12),e=L(z);let s;t[0]!==e?(s=M(e),t[0]=e,t[1]=s):s=t[1];const i=s;let n;t[2]!==i?(n=x(i),t[2]=i,t[3]=n):n=t[3];const o=n;let a;t[4]!==o||t[5]!==r?(a=()=>r?o.get(r)??null:null,t[4]=o,t[5]=r,t[6]=a):a=t[6];const[h,d]=y.useState(a);let u,f;return t[7]!==o||t[8]!==r||t[9]!==i?(u=()=>{if(!r){d(null);return}const k=o.get(r);if(k){d(k);return}let C=!1;return E(r,i).then(b=>{!C&&b&&d(b)}),()=>{C=!0}},f=[r,i,o],t[7]=o,t[8]=r,t[9]=i,t[10]=u,t[11]=f):(u=t[10],f=t[11]),y.useEffect(u,f),h}const _t=(r,t="auto")=>{const e=M(t),s=x(e);for(const i of r)i&&!s.has(i)&&E(i,e)};export{_t as p,dt as u};
