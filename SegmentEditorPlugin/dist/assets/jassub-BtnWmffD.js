import{g as N}from"./react-vendor-NRF3IDaz.js";typeof HTMLVideoElement<"u"&&!("requestVideoFrameCallback"in HTMLVideoElement.prototype)&&"getVideoPlaybackQuality"in HTMLVideoElement.prototype&&(HTMLVideoElement.prototype._rvfcpolyfillmap={},HTMLVideoElement.prototype.requestVideoFrameCallback=function(t){const e=performance.now(),s=this.getVideoPlaybackQuality(),r=this.mozPresentedFrames||this.mozPaintedFrames||s.totalVideoFrames-s.droppedVideoFrames,i=(n,o)=>{const m=this.getVideoPlaybackQuality(),l=this.mozPresentedFrames||this.mozPaintedFrames||m.totalVideoFrames-m.droppedVideoFrames;if(l>r){const c=this.mozFrameDelay||m.totalFrameDelay-s.totalFrameDelay||0,a=o-n;t(o,{presentationTime:o+c*1e3,expectedDisplayTime:o+a,width:this.videoWidth,height:this.videoHeight,mediaTime:Math.max(0,this.currentTime||0)+a/1e3,presentedFrames:l,processingDuration:c}),delete this._rvfcpolyfillmap[e]}else this._rvfcpolyfillmap[e]=requestAnimationFrame(c=>i(o,c))};return this._rvfcpolyfillmap[e]=requestAnimationFrame(n=>i(e,n)),e},HTMLVideoElement.prototype.cancelVideoFrameCallback=function(t){cancelAnimationFrame(this._rvfcpolyfillmap[t]),delete this._rvfcpolyfillmap[t]});var y;(function(t){t.RAW="RAW",t.PROXY="PROXY",t.THROW="THROW",t.HANDLER="HANDLER"})(y||(y={}));var f;(function(t){t.GET="GET",t.SET="SET",t.APPLY="APPLY",t.CONSTRUCT="CONSTRUCT",t.RELEASE="RELEASE"})(f||(f={}));const T=Symbol("Abslink.proxy"),C=Symbol("Abslink.releaseProxy"),g=Symbol("Abslink.finalizer"),F=Symbol("Abslink.thrown"),V=t=>typeof t=="object"&&t!==null||typeof t=="function",I={canHandle:t=>V(t)&&T in t,serialize(t,e){const s=t[T];return j(t,e,s),s},deserialize(t,e){return M(e,void 0,t)}};function W(t){"close"in t&&typeof t.close=="function"&&t.close()}const B={canHandle:t=>V(t)&&F in t,serialize({value:t}){let e;return t instanceof Error?e={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:e={isError:!1,value:t},e},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},P=new Map([["proxy",I],["throw",B]]);function Y(t,e){let s=e;const r=t.slice(0,-1);for(const o of r)Object.prototype.hasOwnProperty.call(s,o)&&(s=s[o]);const i=t[t.length-1],n=i?s[i]:s;return{parent:s,RawValue:n,lastSegment:i}}function j(t,e,s){return e.on("message",function r(i){if(!i)return;const{id:n,type:o,path:m,markerID:l}={path:[],...i};if(l!==s)return;const c=(i.argumentList??[]).map(d=>p(d,e));let a;try{const{parent:d,RawValue:h,lastSegment:w}=Y(m,t);switch(o){case f.GET:a=h;break;case f.SET:d[w]=p(i.value,e),a=!0;break;case f.APPLY:a=h.apply(d,c);break;case f.CONSTRUCT:{const _=new h(...c);a=O(_)}break;case f.RELEASE:a=void 0;break;default:return}}catch(d){a={value:d,[F]:0}}Promise.resolve(a).catch(d=>({value:d,[F]:0})).then(d=>{const h=k(d,e);e.postMessage({...h,id:n,markerID:s}),o===f.RELEASE&&(e.off("message",r),g in t&&typeof t[g]=="function"&&t[g]())}).catch(d=>{const h=k({value:new TypeError("Unserializable return value"),[F]:0},e);e.postMessage({...h,id:n,markerID:s})})}),t}function M(t,e,s){const r=new Map;return t.on("message",i=>{if(!i?.id)return;const n=r.get(i.id);if(n)try{n(i)}finally{r.delete(i.id)}}),L({endpoint:t,pendingListeners:r,nextRequestId:1},[],e,s)}function b(t){if(t)throw new Error("Proxy has been released and is not useable")}async function z(t){await v(t,{type:f.RELEASE}),W(t.endpoint)}const E=new WeakMap,R="FinalizationRegistry"in globalThis&&new FinalizationRegistry(t=>{const e=(E.get(t)??0)-1;E.set(t,e),e===0&&z(t).finally(()=>{t.pendingListeners.clear()})});function G(t,e){const s=(E.get(e)??0)+1;E.set(e,s),R&&R.register(t,e,t)}function Q(t){R&&R.unregister(t)}function L(t,e=[],s=function(){},r){let i=!1;const n=new Map,o=new Proxy(s,{get(m,l){if(b(i),l===C)return async()=>{for(const d of n.values())d[C]();n.clear(),Q(o),z(t).finally(()=>{t.pendingListeners.clear()}),i=!0};if(l==="then"){if(e.length===0)return{then:()=>o};const d=v(t,{type:f.GET,markerID:r,path:e.map(h=>h.toString())}).then(h=>p(h,t.endpoint));return d.then.bind(d)}const c=n.get(l);if(c)return c;const a=L(t,[...e,l],void 0,r);return n.set(l,a),a},set(m,l,c){b(i);const a=k(c,t.endpoint);return v(t,{type:f.SET,markerID:r,path:[...e,l].map(d=>d.toString()),value:a}).then(d=>p(d,t.endpoint))},apply(m,l,c){if(b(i),e[e.length-1]==="bind")return L(t,e.slice(0,-1),void 0,r);const d=S(c,t);return v(t,{type:f.APPLY,markerID:r,path:e.map(h=>h.toString()),argumentList:d}).then(h=>p(h,t.endpoint))},construct(m,l){b(i);const c=S(l,t);return v(t,{type:f.CONSTRUCT,markerID:r,path:e.map(a=>a.toString()),argumentList:c}).then(a=>p(a,t.endpoint))}});return G(o,t),o}function S(t,e){return t.map(s=>k(s,e.endpoint))}function O(t){return Object.assign(t,{[T]:q()})}function k(t,e){for(const[s,r]of P)if(r.canHandle(t)){const i=r.serialize(t,e);return{type:y.HANDLER,name:s,value:i}}return{type:y.RAW,value:t}}function p(t,e){switch(t.type){case y.HANDLER:return P.get(t.name).deserialize(t.value,e);case y.RAW:return t.value}}function v(t,e){return new Promise(s=>{const r=q();t.pendingListeners.set(r,s),t.endpoint.postMessage({id:r,...e})})}function q(){return Math.trunc(Math.random()*Number.MAX_SAFE_INTEGER).toString()}function X(t,e){const s=new WeakMap;return{on(r,i){const n=o=>i(o.data);"addEventListener"in t?t.addEventListener(r,n):"addListener"in t?t.addListener(r,n):t.on(r,n),s.set(i,n)},off(r,i){const n=s.get(i);"removeEventListener"in t?t.removeEventListener(r,n):"removeListener"in t?t.removeListener(r,n):t.off(r,n),s.delete(i)},postMessage(r){e.postMessage(r)},[g]:()=>{t.terminate?.(),e.terminate?.()}}}function $(t,e=t){return M(X(t,e))}var x,A;function K(){if(A)return x;A=1;const t=typeof process<"u"&&!!process.hrtime,e=65535,s=10,r=t?1e9/s:1e3/s,i=t?()=>{const[o,m]=process.hrtime();return o*1e9+m}:()=>performance.now();function n(o){return(i()-o)/r&e}return x=function(o){const m=i(),l=s*(o||5),c=[0];let a=1,d=n(m)-1&e;return function(h){const w=n(m);let _=w-d&e;for(_>l&&(_=l),d=w;_--;)a===l&&(a=0),c[a]=c[a===0?l-1:a-1],a++;h&&(c[a-1]+=h);const H=c[a-1],U=c.length<l?0:c[a===l?0:a];return c.length<s?H:(H-U)*s/c.length}},x}var Z=K();const D=N(Z);class J{fps=D(5);processingDuration=D(5);droppedFrames=0;presentedFrames=0;mistimedFrames=0;_drop(){++this.droppedFrames}_startTime=0;_startFrame(){this._startTime=performance.now()}onsubtitleFrameCallback;_endFrame(e){++this.presentedFrames;const s=this.fps(1),r=performance.now(),i=this.processingDuration((r-this._startTime)/s),n=Math.max(0,r-e.expectedDisplayTime);n&&++this.mistimedFrames,this.onsubtitleFrameCallback?.(r,{fps:s,processingDuration:i,droppedFrames:this.droppedFrames,presentedFrames:this.presentedFrames,mistimedFrames:this.mistimedFrames,presentationTime:r,expectedDisplayTime:e.expectedDisplayTime+(n>0?s/1e3:0),frameDelay:n,width:e.width,height:e.height,mediaTime:e.mediaTime}),console.info("%cFPS: %c%f %c| Frame Time: %c%d ms %c| Dropped Frames: %c%d %c| 5s Avg","color: #888","color: #0f0; font-weight: bold",s.toFixed(1),"color: #888","color: #0ff; font-weight: bold",i,"color: #888","color: #f00; font-weight: bold",this.droppedFrames,"color: #888")}}const ee={rgb:"RGB",bt709:"BT709",bt470bg:"BT601",smpte170m:"BT601"};class u{timeOffset;prescaleFactor;prescaleHeightLimit;maxRenderHeight;debug;renderer;ready;busy=!1;_video;_videoWidth=0;_videoHeight=0;_videoColorSpace=null;_canvas;_canvasParent;_ctrl=new AbortController;_ro=new ResizeObserver(()=>this.resize());_destroyed=!1;_lastDemandTime;_skipped=!1;_worker;constructor(e){if(!globalThis.Worker)throw new Error("Worker not supported");if(!e)throw new Error("No options provided");if(!e.video&&!e.canvas)throw new Error("You should give video or canvas in options.");u._test(),this.timeOffset=e.timeOffset??0,this._video=e.video,this._canvas=e.canvas??document.createElement("canvas"),this._video&&!e.canvas&&(this._canvasParent=document.createElement("div"),this._canvasParent.className="JASSUB",this._canvasParent.style.position="relative",this._canvas.style.display="block",this._canvas.style.position="absolute",this._canvas.style.pointerEvents="none",this._canvasParent.appendChild(this._canvas),this._video.insertAdjacentElement("afterend",this._canvasParent));const s=this._canvas.transferControlToOffscreen();this.debug=e.debug?new J:null,this.prescaleFactor=e.prescaleFactor??1,this.prescaleHeightLimit=e.prescaleHeightLimit??1080,this.maxRenderHeight=e.maxRenderHeight??0,this._worker=e.workerUrl?new Worker(e.workerUrl,{name:"jassub-worker",type:"module"}):new Worker(new URL("/SegmentEditor/assets/worker-BjDxhY9E.js",import.meta.url),{name:"jassub-worker",type:"module"});const r=$(this._worker),i=e.modernWasmUrl??new URL("/SegmentEditor/assets/jassub-worker-modern-BODBPNBq.wasm",import.meta.url).href,n=e.wasmUrl??new URL("/SegmentEditor/assets/jassub-worker-D8lBcBUR.wasm",import.meta.url).href;this.ready=(async()=>{this.renderer=await new r({wasmUrl:u._supportsSIMD?i:n,width:s.width,height:s.height,subUrl:e.subUrl,subContent:e.subContent??null,fonts:e.fonts??[],availableFonts:e.availableFonts??{"liberation sans":"./default.woff2"},fallbackFont:e.fallbackFont??"liberation sans",debug:!!e.debug,libassMemoryLimit:e.libassMemoryLimit??0,libassGlyphLimit:e.libassGlyphLimit??0,useLocalFonts:typeof queryLocalFonts<"u"&&(e.useLocalFonts??!0)},O(o=>this._getLocalFont(o))),await this.renderer.ready()})(),this._video&&this.setVideo(this._video),this._worker.postMessage({name:"offscreenCanvas",ctrl:s},[s])}static _supportsSIMD;static _test(){if(u._supportsSIMD!=null)return;try{u._supportsSIMD=WebAssembly.validate(Uint8Array.of(0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11))}catch{u._supportsSIMD=!1}const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(!(e instanceof WebAssembly.Module)||!(new WebAssembly.Instance(e)instanceof WebAssembly.Instance))throw new Error("WASM not supported")}async resize(e=!!this._video?.paused,s=0,r=0,i=0,n=0){if(await this.ready,(!s||!r)&&this._video){const o=this._getVideoPosition();let m=null;if(this._videoWidth){const l=this._video.videoWidth/this._videoWidth,c=this._video.videoHeight/this._videoHeight;m=this._computeCanvasSize((o.width||0)/l,(o.height||0)/c)}else m=this._computeCanvasSize(o.width||0,o.height||0);s=m.width,r=m.height,this._canvasParent&&(i=o.y-(this._canvasParent.getBoundingClientRect().top-this._video.getBoundingClientRect().top),n=o.x),this._canvas.style.width=o.width+"px",this._canvas.style.height=o.height+"px"}this._canvas.style.top=i+"px",this._canvas.style.left=n+"px",await this.renderer._canvas(s,r,(this._videoWidth||this._video?.videoWidth)??s,(this._videoHeight||this._video?.videoHeight)??r),e&&this._lastDemandTime&&this._demandRender()}_getVideoPosition(e=this._video.videoWidth,s=this._video.videoHeight){const r=e/s,{offsetWidth:i,offsetHeight:n}=this._video,o=i/n;e=i,s=n,o>r?e=Math.floor(n*r):s=Math.floor(i/r);const m=(i-e)/2,l=(n-s)/2;return{width:e,height:s,x:m,y:l}}_computeCanvasSize(e=0,s=0){const r=this.prescaleFactor<=0?1:this.prescaleFactor,i=self.devicePixelRatio||1;if(s<=0||e<=0)e=0,s=0;else{const n=r<1?-1:1;let o=s*i;n*o*r<=n*this.prescaleHeightLimit?o*=r:n*o<n*this.prescaleHeightLimit&&(o=this.prescaleHeightLimit),this.maxRenderHeight>0&&o>this.maxRenderHeight&&(o=this.maxRenderHeight),e*=o/s,s=o}return{width:e,height:s}}async setVideo(e){if(await this.ready,e instanceof HTMLVideoElement)this._removeListeners(),this._video=e,this._video.requestVideoFrameCallback((s,r)=>this._handleRVFC(r)),"VideoFrame"in globalThis&&(e.addEventListener("loadedmetadata",()=>this._updateColorSpace(),this._ctrl),e.readyState>2&&this._updateColorSpace()),e.videoWidth>0&&this.resize(),this._ro.observe(e);else throw new Error("Video element invalid!")}async _sendLocalFont(e){try{const r=(await queryLocalFonts())?.find(i=>i.fullName.toLowerCase()===e);if(r){const i=await r.blob();this.renderer.addFont(new Uint8Array(await i.arrayBuffer()))}}catch(s){console.warn("Local fonts API:",s)}}async _getLocalFont(e){try{navigator?.permissions?.query?(await navigator.permissions.query({name:"local-fonts"})).state==="granted"&&await this._sendLocalFont(e):await this._sendLocalFont(e)}catch(s){console.warn("Local fonts API:",s)}}_handleRVFC(e){this._destroyed||(this._lastDemandTime=e,this._demandRender(),this._video.requestVideoFrameCallback((s,r)=>this._handleRVFC(r)))}async _demandRender(){const{mediaTime:e,width:s,height:r}=this._lastDemandTime;if((s!==this._videoWidth||r!==this._videoHeight)&&(this._videoWidth=s,this._videoHeight=r,this.resize(!1)),this.busy){this._skipped=!0,this.debug?._drop();return}this.busy=!0,this._skipped=!1,this.debug?._startFrame(),await this.renderer._draw(e+this.timeOffset),this.debug?._endFrame(this._lastDemandTime),this.busy=!1,this._skipped&&this._demandRender()}async _updateColorSpace(){await this.ready,this._video.requestVideoFrameCallback(async()=>{try{const e=new VideoFrame(this._video);e.close(),await this.renderer._setColorSpace(ee[e.colorSpace.matrix])}catch(e){console.warn(e)}})}_removeListeners(){this._video&&(this._ro&&this._ro.unobserve(this._video),this._ctrl.abort(),this._ctrl=new AbortController)}async destroy(){this._destroyed||(this._destroyed=!0,this._video&&this._canvasParent&&this._video.parentNode?.removeChild(this._canvasParent),this._removeListeners(),await this.renderer[C](),this._worker.terminate())}}export{u as default};
