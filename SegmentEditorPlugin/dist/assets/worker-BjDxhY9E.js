(function(){"use strict";var J;(function(o){o.RAW="RAW",o.PROXY="PROXY",o.THROW="THROW",o.HANDLER="HANDLER"})(J||(J={}));var x;(function(o){o.GET="GET",o.SET="SET",o.APPLY="APPLY",o.CONSTRUCT="CONSTRUCT",o.RELEASE="RELEASE"})(x||(x={}));const Oe=Symbol("Abslink.proxy"),er=Symbol("Abslink.releaseProxy"),ne=Symbol("Abslink.finalizer"),ge=Symbol("Abslink.thrown"),rr=o=>typeof o=="object"&&o!==null||typeof o=="function",_t={canHandle:o=>rr(o)&&Oe in o,serialize(o,i){const s=o[Oe];return nr(o,i,s),s},deserialize(o,i){return yt(i,void 0,o)}};function vt(o){"close"in o&&typeof o.close=="function"&&o.close()}const gt={canHandle:o=>rr(o)&&ge in o,serialize({value:o}){let i;return o instanceof Error?i={isError:!0,value:{message:o.message,name:o.name,stack:o.stack}}:i={isError:!1,value:o},i},deserialize(o){throw o.isError?Object.assign(new Error(o.value.message),o.value):o.value}},tr=new Map([["proxy",_t],["throw",gt]]);function pt(o,i){let s=i;const d=o.slice(0,-1);for(const T of d)Object.prototype.hasOwnProperty.call(s,T)&&(s=s[T]);const _=o[o.length-1],v=_?s[_]:s;return{parent:s,RawValue:v,lastSegment:_}}function nr(o,i,s){return i.on("message",function d(_){if(!_)return;const{id:v,type:T,path:g,markerID:A}={path:[],..._};if(A!==s)return;const E=(_.argumentList??[]).map(w=>Q(w,i));let h;try{const{parent:w,RawValue:C,lastSegment:B}=pt(g,o);switch(T){case x.GET:h=C;break;case x.SET:w[B]=Q(_.value,i),h=!0;break;case x.APPLY:h=C.apply(w,E);break;case x.CONSTRUCT:{const N=new C(...E);h=Tt(N)}break;case x.RELEASE:h=void 0;break;default:return}}catch(w){h={value:w,[ge]:0}}Promise.resolve(h).catch(w=>({value:w,[ge]:0})).then(w=>{const C=be(w,i);i.postMessage({...C,id:v,markerID:s}),T===x.RELEASE&&(i.off("message",d),ne in o&&typeof o[ne]=="function"&&o[ne]())}).catch(w=>{const C=be({value:new TypeError("Unserializable return value"),[ge]:0},i);i.postMessage({...C,id:v,markerID:s})})}),o}function yt(o,i,s){const d=new Map;return o.on("message",_=>{if(!_?.id)return;const v=d.get(_.id);if(v)try{v(_)}finally{d.delete(_.id)}}),Ie({endpoint:o,pendingListeners:d,nextRequestId:1},[],i,s)}function pe(o){if(o)throw new Error("Proxy has been released and is not useable")}async function ir(o){await ie(o,{type:x.RELEASE}),vt(o.endpoint)}const ye=new WeakMap,me="FinalizationRegistry"in globalThis&&new FinalizationRegistry(o=>{const i=(ye.get(o)??0)-1;ye.set(o,i),i===0&&ir(o).finally(()=>{o.pendingListeners.clear()})});function mt(o,i){const s=(ye.get(i)??0)+1;ye.set(i,s),me&&me.register(o,i,o)}function bt(o){me&&me.unregister(o)}function Ie(o,i=[],s=function(){},d){let _=!1;const v=new Map,T=new Proxy(s,{get(g,A){if(pe(_),A===er)return async()=>{for(const w of v.values())w[er]();v.clear(),bt(T),ir(o).finally(()=>{o.pendingListeners.clear()}),_=!0};if(A==="then"){if(i.length===0)return{then:()=>T};const w=ie(o,{type:x.GET,markerID:d,path:i.map(C=>C.toString())}).then(C=>Q(C,o.endpoint));return w.then.bind(w)}const E=v.get(A);if(E)return E;const h=Ie(o,[...i,A],void 0,d);return v.set(A,h),h},set(g,A,E){pe(_);const h=be(E,o.endpoint);return ie(o,{type:x.SET,markerID:d,path:[...i,A].map(w=>w.toString()),value:h}).then(w=>Q(w,o.endpoint))},apply(g,A,E){if(pe(_),i[i.length-1]==="bind")return Ie(o,i.slice(0,-1),void 0,d);const w=ar(E,o);return ie(o,{type:x.APPLY,markerID:d,path:i.map(C=>C.toString()),argumentList:w}).then(C=>Q(C,o.endpoint))},construct(g,A){pe(_);const E=ar(A,o);return ie(o,{type:x.CONSTRUCT,markerID:d,path:i.map(h=>h.toString()),argumentList:E}).then(h=>Q(h,o.endpoint))}});return mt(T,o),T}function ar(o,i){return o.map(s=>be(s,i.endpoint))}function Tt(o){return Object.assign(o,{[Oe]:sr()})}function be(o,i){for(const[s,d]of tr)if(d.canHandle(o)){const _=d.serialize(o,i);return{type:J.HANDLER,name:s,value:_}}return{type:J.RAW,value:o}}function Q(o,i){switch(o.type){case J.HANDLER:return tr.get(o.name).deserialize(o.value,i);case J.RAW:return o.value}}function ie(o,i){return new Promise(s=>{const d=sr();o.pendingListeners.set(d,s),o.endpoint.postMessage({id:d,...i})})}function sr(){return Math.trunc(Math.random()*Number.MAX_SAFE_INTEGER).toString()}function wt(o,i){const s=new WeakMap;return{on(d,_){const v=T=>_(T.data);"addEventListener"in o?o.addEventListener(d,v):"addListener"in o?o.addListener(d,v):o.on(d,v),s.set(_,v)},off(d,_){const v=s.get(_);"removeEventListener"in o?o.removeEventListener(d,v):"removeListener"in o?o.removeListener(d,v):o.off(d,v),s.delete(_)},postMessage(d){i.postMessage(d)},[ne]:()=>{o.terminate?.(),i.terminate?.()}}}function At(o,i=self,s=i){return nr(o,wt(i,s))}async function or(o={}){var i,s=o,d=(...e)=>console.log(...e),_=(...e)=>console.error(...e);function v(){w?.(s),g&&C()}var T=!!globalThis.WorkerGlobalScope,g=T&&self.name?.startsWith("em-pthread");const A=!!WebAssembly.Memory.prototype.toResizableBuffer;if(q=()=>{if(!(A&&self.HEAPU8RAW)){var e=A?I.toResizableBuffer():I.buffer;N=new Int8Array(e),X=new Int16Array(e),k=new Uint8Array(e),Y=new Uint16Array(e),V=new Int32Array(e),S=new Uint32Array(e),ae=new Float32Array(e),Z=new Float64Array(e),H=new BigInt64Array(e),se=new BigUint64Array(e),self.HEAPU8RAW=new Uint8Array(e),self.WASMMEMORY=I}},self.name.startsWith("em-pthread")){const e=self.name.split("-").slice(2).join("-"),r=globalThis.fetch;globalThis.fetch=t=>r(e)}else{const e=globalThis.Worker;globalThis.Worker=class extends e{constructor(r,t={}){super(r,{...t,name:"em-pthread-"+o.__url})}}}function E(e){throw e}function h(){I.buffer!=N.buffer&&q()}var w,C;if(g){let e=function(r){try{var t=r.data,n=t.cmd;if(n==="load"){let a=[];self.onmessage=l=>a.push(l),C=()=>{postMessage({cmd:"loaded"});for(let l of a)e(l);self.onmessage=e};for(const l of t.handlers)(!s[l]||s[l].proxy)&&(s[l]=(...u)=>{postMessage({cmd:"callHandler",handler:l,args:u})},l=="print"&&(d=s[l]),l=="printErr"&&(_=s[l]));I=t.wasmMemory,q(),s.wasm=t.wasmModule,ct()}else if(n==="run"){Lt(t.pthread_ptr),Je(t.pthread_ptr,0,0,1,0,0),y.threadInitTLS(),Ye(t.pthread_ptr),B||(qr(),B=!0);try{Ot(t.start_routine,t.arg)}catch(a){if(a!="unwind")throw a}}else t.target==="setimmediate"||(n==="checkMailbox"?B&&We():n&&(_(`worker: received unknown command ${n}`),_(t)))}catch(a){throw Kr(),a}};var B=!1;self.onunhandledrejection=r=>{throw r.reason||r},self.onmessage=e}var N,k,X,Y,V,S,ae,Z,H,se,Ae=!1;function q(){var e=I.buffer;N=new Int8Array(e),X=new Int16Array(e),k=new Uint8Array(e),Y=new Uint16Array(e),V=new Int32Array(e),S=new Uint32Array(e),ae=new Float32Array(e),Z=new Float64Array(e),H=new BigInt64Array(e),se=new BigUint64Array(e)}function De(){if(!g){{var e=62914560;I=new WebAssembly.Memory({initial:e/65536,maximum:32768,shared:!0})}q()}}De();var $e=e=>{e.terminate(),e.onmessage=r=>{}},Pe=e=>{var r=y.pthreads[e];y.returnWorkerToPool(r)},xt=e=>{for(;e.length>0;)e.shift()(s)},Mt=[],vr=e=>{var r=y.getNewWorker();if(!r)return 6;y.runningWorkers.push(r),y.pthreads[e.pthread_ptr]=r,r.pthread_ptr=e.pthread_ptr;var t={cmd:"run",start_routine:e.startRoutine,arg:e.arg,pthread_ptr:e.pthread_ptr};return r.postMessage(t,e.transferList),0},Ce=()=>st(),oe=e=>it(e),Wt=e=>at(e),M=(e,r,t,...n)=>{for(var a=n.length*2,l=Ce(),u=Wt(a*8),c=u>>3,f=0;f<n.length;f++){var p=n[f];typeof p=="bigint"?((h(),H)[c+2*f]=1n,(h(),H)[c+2*f+1]=p):((h(),H)[c+2*f]=0n,(h(),Z)[c+2*f+1]=p)}var b=Jr(e,r,a,u,t);return oe(l),b};function Be(e){if(g)return M(0,0,1,e);throw`exit(${e})`}var Ut=Be,y={unusedWorkers:[],runningWorkers:[],tlsInitFunctions:[],pthreads:{},init(){g||y.initMainThread()},initMainThread(){for(var e=self.crossOriginIsolated?Math.min(Math.max(0,navigator.hardwareConcurrency-2),8):0;e--;)y.allocateUnusedWorker()},terminateAllThreads:()=>{for(var e of y.runningWorkers)$e(e);for(var e of y.unusedWorkers)$e(e);y.unusedWorkers=[],y.runningWorkers=[],y.pthreads={}},returnWorkerToPool:e=>{var r=e.pthread_ptr;delete y.pthreads[r],y.unusedWorkers.push(e),y.runningWorkers.splice(y.runningWorkers.indexOf(e),1),e.pthread_ptr=0,Qr(r)},threadInitTLS(){y.tlsInitFunctions.forEach(e=>e())},loadWasmModuleToWorker:e=>new Promise(r=>{e.onmessage=l=>{var u=l.data,c=u.cmd;if(u.targetThread&&u.targetThread!=Ke()){var f=y.pthreads[u.targetThread];f?f.postMessage(u,u.transferList):_(`Internal error! Worker sent a message "${c}" to target pthread ${u.targetThread}, but that thread no longer exists!`);return}c==="checkMailbox"?We():c==="spawnThread"?vr(u):c==="cleanupThread"?Xe(()=>Pe(u.thread)):c==="loaded"?(e.loaded=!0,r(e)):u.target==="setimmediate"?e.postMessage(u):c==="callHandler"?s[u.handler](...u.args):c&&_(`worker sent an unknown command ${c}`)},e.onerror=l=>{var u="worker sent an error!";throw _(`${u} ${l.filename}:${l.lineno}: ${l.message}`),l};var t=[],n=[];for(var a of n)s.propertyIsEnumerable(a)&&t.push(a);e.postMessage({cmd:"load",handlers:t,wasmMemory:I,wasmModule:ut})}),async loadWasmModuleToAllWorkers(){return g?void 0:Promise.all(y.unusedWorkers.map(y.loadWasmModuleToWorker))},allocateUnusedWorker(){var e;e=new Worker(new URL("/SegmentEditor/assets/jassub-worker-BS3o9SkZ.js",self.location.href),{type:"module",name:"em-pthread"}),y.unusedWorkers.push(e)},getNewWorker(){return y.unusedWorkers.length==0&&(y.allocateUnusedWorker(),y.loadWasmModuleToWorker(y.unusedWorkers[0])),y.unusedWorkers.pop()}};function Lt(e){var r=(h(),S)[e+52>>2],t=(h(),S)[e+56>>2],n=r-t;nt(r,n),oe(r)}var gr=[],le=e=>{var r=gr[e];return r||(gr[e]=r=ot.get(e)),r},Ot=(e,r)=>{var t=le(e)(r);function n(a){et(a)}n(t)},I,pr=new TextDecoder,Ne=(e,r,t,n)=>{var a=r+t;if(n)return a;for(;e[r]&&!(r>=a);)++r;return r},ue=(e,r,t)=>{if(!e)return"";var n=Ne((h(),k),e,r,t);return pr.decode((h(),k).slice(e,n))},It=(e,r,t,n)=>E(`Assertion failed: ${ue(e)}, at: `+[r?ue(r):"unknown filename",t,n?ue(n):"unknown function"]);function yr(e,r,t,n){return g?M(1,0,1,e,r,t,n):mr(e,r,t,n)}var Ht=()=>!!globalThis.SharedArrayBuffer,mr=(e,r,t,n)=>{if(!Ht())return 6;var a=[],l=0;if(g&&(a.length===0||l))return yr(e,r,t,n);var u={startRoutine:t,pthread_ptr:e,arg:n,transferList:a};return g?(u.cmd="spawnThread",postMessage(u,a),0):vr(u)};function br(e,r,t){return g?M(2,0,1,e,r,t):0}function Tr(e,r,t){if(g)return M(3,0,1,e,r,t)}function wr(e,r,t){return g?M(4,0,1,e,r,t):0}function Ar(e,r,t,n){if(g)return M(5,0,1,e,r,t,n)}var Dt=()=>E(""),W=e=>{for(var r="";;){var t=(h(),k)[e++];if(!t)return r;r+=String.fromCharCode(t)}},ee={},re={},Se={},ce=class extends Error{constructor(r){super(r),this.name="BindingError"}},m=e=>{throw new ce(e)};function Bt(e,r,t={}){var n=r.name;if(e||m(`type "${n}" must have a positive integer typeid pointer`),re.hasOwnProperty(e)){if(t.ignoreDuplicateRegistrations)return;m(`Cannot register type '${n}' twice`)}if(re[e]=r,delete Se[e],ee.hasOwnProperty(e)){var a=ee[e];delete ee[e],a.forEach(l=>l())}}function D(e,r,t={}){return Bt(e,r,t)}var $r=(e,r,t)=>{switch(r){case 1:return t?n=>(h(),N)[n]:n=>(h(),k)[n];case 2:return t?n=>(h(),X)[n>>1]:n=>(h(),Y)[n>>1];case 4:return t?n=>(h(),V)[n>>2]:n=>(h(),S)[n>>2];case 8:return t?n=>(h(),H)[n>>3]:n=>(h(),se)[n>>3];default:throw new TypeError(`invalid integer width (${r}): ${e}`)}},Nt=(e,r,t,n,a)=>{r=W(r);const l=n===0n;let u=c=>c;if(l){const c=t*8;u=f=>BigInt.asUintN(c,f),a=u(a)}D(e,{name:r,fromWireType:u,toWireType:(c,f)=>(typeof f=="number"&&(f=BigInt(f)),f),readValueFromPointer:$r(r,t,!l),destructorFunction:null})},Vt=(e,r,t,n)=>{r=W(r),D(e,{name:r,fromWireType:function(a){return!!a},toWireType:function(a,l){return l?t:n},readValueFromPointer:function(a){return this.fromWireType((h(),k)[a])},destructorFunction:null})},jt=e=>({count:e.count,deleteScheduled:e.deleteScheduled,preservePointerOnDelete:e.preservePointerOnDelete,ptr:e.ptr,ptrType:e.ptrType,smartPtr:e.smartPtr,smartPtrType:e.smartPtrType}),Ve=e=>{function r(t){return t.$$.ptrType.registeredClass.name}m(r(e)+" instance already deleted")},je=!1,Pr=e=>{},zt=e=>{e.smartPtr?e.smartPtrType.rawDestructor(e.smartPtr):e.ptrType.registeredClass.rawDestructor(e.ptr)},Cr=e=>{e.count.value-=1;var r=e.count.value===0;r&&zt(e)},fe=e=>globalThis.FinalizationRegistry?(je=new FinalizationRegistry(r=>{Cr(r.$$)}),fe=r=>{var t=r.$$,n=!!t.smartPtr;if(n){var a={$$:t};je.register(r,a,r)}return r},Pr=r=>je.unregister(r),fe(e)):(fe=r=>r,e),Gt=()=>{let e=Ee.prototype;Object.assign(e,{isAliasOf(t){if(!(this instanceof Ee)||!(t instanceof Ee))return!1;var n=this.$$.ptrType.registeredClass,a=this.$$.ptr;t.$$=t.$$;for(var l=t.$$.ptrType.registeredClass,u=t.$$.ptr;n.baseClass;)a=n.upcast(a),n=n.baseClass;for(;l.baseClass;)u=l.upcast(u),l=l.baseClass;return n===l&&a===u},clone(){if(this.$$.ptr||Ve(this),this.$$.preservePointerOnDelete)return this.$$.count.value+=1,this;var t=fe(Object.create(Object.getPrototypeOf(this),{$$:{value:jt(this.$$)}}));return t.$$.count.value+=1,t.$$.deleteScheduled=!1,t},delete(){this.$$.ptr||Ve(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&m("Object already scheduled for deletion"),Pr(this),Cr(this.$$),this.$$.preservePointerOnDelete||(this.$$.smartPtr=void 0,this.$$.ptr=void 0)},isDeleted(){return!this.$$.ptr},deleteLater(){return this.$$.ptr||Ve(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&m("Object already scheduled for deletion"),this.$$.deleteScheduled=!0,this}});const r=Symbol.dispose;r&&(e[r]=e.delete)};function Ee(){}var Sr=(e,r)=>Object.defineProperty(r,"name",{value:e}),Er={},Rr=(e,r,t)=>{if(e[r].overloadTable===void 0){var n=e[r];e[r]=function(...a){return e[r].overloadTable.hasOwnProperty(a.length)||m(`Function '${t}' called with an invalid number of arguments (${a.length}) - expects one of (${e[r].overloadTable})!`),e[r].overloadTable[a.length].apply(this,a)},e[r].overloadTable=[],e[r].overloadTable[n.argCount]=n}},Xt=(e,r,t)=>{s.hasOwnProperty(e)?(m(`Cannot register public name '${e}' twice`),Rr(s,e,e),s[e].overloadTable.hasOwnProperty(t)&&m(`Cannot register multiple overloads of a function with the same number of arguments (${t})!`),s[e].overloadTable[t]=r):(s[e]=r,s[e].argCount=t)},Yt=48,Zt=57,qt=e=>{e=e.replace(/[^a-zA-Z0-9_]/g,"$");var r=e.charCodeAt(0);return r>=Yt&&r<=Zt?`_${e}`:e};function Kt(e,r,t,n,a,l,u,c){this.name=e,this.constructor=r,this.instancePrototype=t,this.rawDestructor=n,this.baseClass=a,this.getActualType=l,this.upcast=u,this.downcast=c,this.pureVirtualFunctions=[]}var Re=(e,r,t)=>{for(;r!==t;)r.upcast||m(`Expected null or instance of ${t.name}, got an instance of ${r.name}`),e=r.upcast(e),r=r.baseClass;return e},ze=e=>{if(e===null)return"null";var r=typeof e;return r==="object"||r==="array"||r==="function"?e.toString():""+e};function Jt(e,r){if(r===null)return this.isReference&&m(`null is not a valid ${this.name}`),0;r.$$||m(`Cannot pass "${ze(r)}" as a ${this.name}`),r.$$.ptr||m(`Cannot pass deleted object as a pointer of type ${this.name}`);var t=r.$$.ptrType.registeredClass,n=Re(r.$$.ptr,t,this.registeredClass);return n}function Qt(e,r){var t;if(r===null)return this.isReference&&m(`null is not a valid ${this.name}`),this.isSmartPointer?(t=this.rawConstructor(),e!==null&&e.push(this.rawDestructor,t),t):0;(!r||!r.$$)&&m(`Cannot pass "${ze(r)}" as a ${this.name}`),r.$$.ptr||m(`Cannot pass deleted object as a pointer of type ${this.name}`),!this.isConst&&r.$$.ptrType.isConst&&m(`Cannot convert argument of type ${r.$$.smartPtrType?r.$$.smartPtrType.name:r.$$.ptrType.name} to parameter type ${this.name}`);var n=r.$$.ptrType.registeredClass;if(t=Re(r.$$.ptr,n,this.registeredClass),this.isSmartPointer)switch(r.$$.smartPtr===void 0&&m("Passing raw pointer to smart pointer is illegal"),this.sharingPolicy){case 0:r.$$.smartPtrType===this?t=r.$$.smartPtr:m(`Cannot convert argument of type ${r.$$.smartPtrType?r.$$.smartPtrType.name:r.$$.ptrType.name} to parameter type ${this.name}`);break;case 1:t=r.$$.smartPtr;break;case 2:if(r.$$.smartPtrType===this)t=r.$$.smartPtr;else{var a=r.clone();t=this.rawShare(t,Ge.toHandle(()=>a.delete())),e!==null&&e.push(this.rawDestructor,t)}break;default:m("Unsupporting sharing policy")}return t}function en(e,r){if(r===null)return this.isReference&&m(`null is not a valid ${this.name}`),0;r.$$||m(`Cannot pass "${ze(r)}" as a ${this.name}`),r.$$.ptr||m(`Cannot pass deleted object as a pointer of type ${this.name}`),r.$$.ptrType.isConst&&m(`Cannot convert argument of type ${r.$$.ptrType.name} to parameter type ${this.name}`);var t=r.$$.ptrType.registeredClass,n=Re(r.$$.ptr,t,this.registeredClass);return n}function Fe(e){return this.fromWireType((h(),S)[e>>2])}var Fr=(e,r,t)=>{if(r===t)return e;if(t.baseClass===void 0)return null;var n=Fr(e,r,t.baseClass);return n===null?null:t.downcast(n)},rn={},tn=(e,r)=>{for(r===void 0&&m("ptr should not be undefined");e.baseClass;)r=e.upcast(r),e=e.baseClass;return r},nn=(e,r)=>(r=tn(e,r),rn[r]),an=class extends Error{constructor(r){super(r),this.name="InternalError"}},ke=e=>{throw new an(e)},xe=(e,r)=>{(!r.ptrType||!r.ptr)&&ke("makeClassHandle requires ptr and ptrType");var t=!!r.smartPtrType,n=!!r.smartPtr;return t!==n&&ke("Both smartPtrType and smartPtr must be specified"),r.count={value:1},fe(Object.create(e,{$$:{value:r,writable:!0}}))};function sn(e){var r=this.getPointee(e);if(!r)return this.destructor(e),null;var t=nn(this.registeredClass,r);if(t!==void 0){if(t.$$.count.value===0)return t.$$.ptr=r,t.$$.smartPtr=e,t.clone();var n=t.clone();return this.destructor(e),n}function a(){return this.isSmartPointer?xe(this.registeredClass.instancePrototype,{ptrType:this.pointeeType,ptr:r,smartPtrType:this,smartPtr:e}):xe(this.registeredClass.instancePrototype,{ptrType:this,ptr:e})}var l=this.registeredClass.getActualType(r),u=Er[l];if(!u)return a.call(this);var c;this.isConst?c=u.constPointerType:c=u.pointerType;var f=Fr(r,this.registeredClass,c.registeredClass);return f===null?a.call(this):this.isSmartPointer?xe(c.registeredClass.instancePrototype,{ptrType:c,ptr:f,smartPtrType:this,smartPtr:e}):xe(c.registeredClass.instancePrototype,{ptrType:c,ptr:f})}var on=()=>{Object.assign(Me.prototype,{getPointee(e){return this.rawGetPointee&&(e=this.rawGetPointee(e)),e},destructor(e){this.rawDestructor?.(e)},readValueFromPointer:Fe,fromWireType:sn})};function Me(e,r,t,n,a,l,u,c,f,p,b){this.name=e,this.registeredClass=r,this.isReference=t,this.isConst=n,this.isSmartPointer=a,this.pointeeType=l,this.sharingPolicy=u,this.rawGetPointee=c,this.rawConstructor=f,this.rawShare=p,this.rawDestructor=b,!a&&r.baseClass===void 0?n?(this.toWireType=Jt,this.destructorFunction=null):(this.toWireType=en,this.destructorFunction=null):this.toWireType=Qt}var ln=(e,r,t)=>{s.hasOwnProperty(e)||ke("Replacing nonexistent public symbol"),s[e].overloadTable!==void 0&&t!==void 0||(s[e]=r,s[e].argCount=t)},z=(e,r,t=!1)=>{e=W(e);function n(){var l=le(r);return l}var a=n();return typeof a!="function"&&m(`unknown function pointer with signature ${e}: ${r}`),a};class un extends Error{}var cn=e=>{var r=Zr(e),t=W(r);return G(r),t},he=(e,r)=>{var t=[],n={};function a(l){if(!n[l]&&!re[l]){if(Se[l]){Se[l].forEach(a);return}t.push(l),n[l]=!0}}throw r.forEach(a),new un(`${e}: `+t.map(cn).join([", "]))},K=(e,r,t)=>{e.forEach(c=>Se[c]=r);function n(c){var f=t(c);f.length!==e.length&&ke("Mismatched type converter count");for(var p=0;p<e.length;++p)D(e[p],f[p])}var a=new Array(r.length),l=[],u=0;for(let[c,f]of r.entries())re.hasOwnProperty(f)?a[c]=re[f]:(l.push(f),ee.hasOwnProperty(f)||(ee[f]=[]),ee[f].push(()=>{a[c]=re[f],++u,u===l.length&&n(a)}));l.length===0&&n(a)},fn=(e,r,t,n,a,l,u,c,f,p,b,P,R)=>{b=W(b),l=z(a,l),c&&=z(u,c),p&&=z(f,p),R=z(P,R);var $=qt(b);Xt($,function(){he(`Cannot construct ${b} due to unbound types`,[n])}),K([e,r,t],n?[n]:[],F=>{F=F[0];var L,j;n?(L=F.registeredClass,j=L.instancePrototype):j=Ee.prototype;var O=Sr(b,function(...Qe){if(Object.getPrototypeOf(this)!==ve)throw new ce(`Use 'new' to construct ${b}`);if(U.constructor_body===void 0)throw new ce(`${b} has no accessible constructor`);var dt=U.constructor_body[Qe.length];if(dt===void 0)throw new ce(`Tried to invoke ctor of ${b} with invalid number of parameters (${Qe.length}) - expected (${Object.keys(U.constructor_body).toString()}) parameters instead!`);return dt.apply(this,Qe)}),ve=Object.create(j,{constructor:{value:O}});O.prototype=ve;var U=new Kt(b,O,ve,R,L,l,c,p);U.baseClass&&(U.baseClass.__derivedClasses??=[],U.baseClass.__derivedClasses.push(U));var _i=new Me(b,U,!0,!1,!1),ft=new Me(b+"*",U,!1,!1,!1),ht=new Me(b+" const*",U,!1,!0,!1);return Er[e]={pointerType:ft,constPointerType:ht},ln($,O),[_i,ft,ht]})},kr=(e,r)=>{for(var t=[],n=0;n<e;n++)t.push((h(),S)[r+n*4>>2]);return t},xr=e=>{for(;e.length;){var r=e.pop(),t=e.pop();t(r)}};function Mr(e){for(var r=1;r<e.length;++r)if(e[r]!==null&&e[r].destructorFunction===void 0)return!0;return!1}function hn(e,r,t,n){var a=Mr(e),l=e.length-2,u=[],c=["fn"];r&&c.push("thisWired");for(var f=0;f<l;++f)u.push(`arg${f}`),c.push(`arg${f}Wired`);u=u.join(","),c=c.join(",");var p=`return function (${u}) {
`;a&&(p+=`var destructors = [];
`);var b=a?"destructors":"null",P=["humanName","throwBindingError","invoker","fn","runDestructors","fromRetWire","toClassParamWire"];r&&(p+=`var thisWired = toClassParamWire(${b}, this);
`);for(var f=0;f<l;++f){var R=`toArg${f}Wire`;p+=`var arg${f}Wired = ${R}(${b}, arg${f});
`,P.push(R)}if(p+=(t||n?"var rv = ":"")+`invoker(${c});
`,a)p+=`runDestructors(destructors);
`;else for(var f=r?1:2;f<e.length;++f){var $=f===1?"thisWired":"arg"+(f-2)+"Wired";e[f].destructorFunction!==null&&(p+=`${$}_dtor(${$});
`,P.push(`${$}_dtor`))}return t&&(p+=`var ret = fromRetWire(rv);
return ret;
`),p+=`}
`,new Function(P,p)}function Wr(e,r,t,n,a,l){var u=r.length;u<2&&m("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var c=r[1]!==null&&t!==null,f=Mr(r),p=!r[0].isVoid,b=r[0],P=r[1],R=[e,m,n,a,xr,b.fromWireType.bind(b),P?.toWireType.bind(P)],$=2;$<u;++$){var F=r[$];R.push(F.toWireType.bind(F))}if(!f)for(var $=c?1:2;$<r.length;++$)r[$].destructorFunction!==null&&R.push(r[$].destructorFunction);var j=hn(r,c,p,l)(...R);return Sr(e,j)}var dn=(e,r,t,n,a,l)=>{var u=kr(r,t);a=z(n,a),K([],[e],c=>{c=c[0];var f=`constructor ${c.name}`;if(c.registeredClass.constructor_body===void 0&&(c.registeredClass.constructor_body=[]),c.registeredClass.constructor_body[r-1]!==void 0)throw new ce(`Cannot register multiple constructors with identical number of parameters (${r-1}) for class '${c.name}'! Overload resolution is currently only performed using the parameter count, not actual type info!`);return c.registeredClass.constructor_body[r-1]=()=>{he(`Cannot construct ${c.name} due to unbound types`,u)},K([],u,p=>(p.splice(1,0,null),c.registeredClass.constructor_body[r-1]=Wr(f,p,null,a,l),[])),[]})},_n=e=>{e=e.trim();const r=e.indexOf("(");return r===-1?e:e.slice(0,r)},vn=(e,r,t,n,a,l,u,c,f,p)=>{var b=kr(t,n);r=W(r),r=_n(r),l=z(a,l,f),K([],[e],P=>{P=P[0];var R=`${P.name}.${r}`;r.startsWith("@@")&&(r=Symbol[r.substring(2)]),c&&P.registeredClass.pureVirtualFunctions.push(r);function $(){he(`Cannot call ${R} due to unbound types`,b)}var F=P.registeredClass.instancePrototype,L=F[r];return L===void 0||L.overloadTable===void 0&&L.className!==P.name&&L.argCount===t-2?($.argCount=t-2,$.className=P.name,F[r]=$):(Rr(F,r,R),F[r].overloadTable[t-2]=$),K([],b,j=>{var O=Wr(R,j,P,l,u,f);return F[r].overloadTable===void 0?(O.argCount=t-2,F[r]=O):F[r].overloadTable[t-2]=O,[]}),[]})},Ur=(e,r,t)=>(e instanceof Object||m(`${t} with invalid "this": ${e}`),e instanceof r.registeredClass.constructor||m(`${t} incompatible with "this" of type ${e.constructor.name}`),e.$$.ptr||m(`cannot call emscripten binding method ${t} on deleted object`),Re(e.$$.ptr,e.$$.ptrType.registeredClass,r.registeredClass)),gn=(e,r,t,n,a,l,u,c,f,p)=>{r=W(r),a=z(n,a),K([],[e],b=>{b=b[0];var P=`${b.name}.${r}`,R={get(){he(`Cannot access ${P} due to unbound types`,[t,u])},enumerable:!0,configurable:!0};return f?R.set=()=>he(`Cannot access ${P} due to unbound types`,[t,u]):R.set=$=>m(P+" is a read-only property"),Object.defineProperty(b.registeredClass.instancePrototype,r,R),K([],f?[t,u]:[t],$=>{var F=$[0],L={get(){var O=Ur(this,b,P+" getter");return F.fromWireType(a(l,O))},enumerable:!0};if(f){f=z(c,f);var j=$[1];L.set=function(O){var ve=Ur(this,b,P+" setter"),U=[];f(p,ve,j.toWireType(U,O)),xr(U)}}return Object.defineProperty(b.registeredClass.instancePrototype,r,L),[]}),[]})},Lr=[],te=[0,1,,1,null,1,!0,1,!1,1],pn=e=>{e>9&&--te[e+1]===0&&(te[e]=void 0,Lr.push(e))},Ge={toValue:e=>(e||m(`Cannot use deleted val. handle = ${e}`),te[e]),toHandle:e=>{switch(e){case void 0:return 2;case null:return 4;case!0:return 6;case!1:return 8;default:{const r=Lr.pop()||te.length;return te[r]=e,te[r+1]=1,r}}}},yn={name:"emscripten::val",fromWireType:e=>{var r=Ge.toValue(e);return pn(e),r},toWireType:(e,r)=>Ge.toHandle(r),readValueFromPointer:Fe,destructorFunction:null},mn=e=>D(e,yn),bn=(e,r)=>{switch(r){case 4:return function(t){return this.fromWireType((h(),ae)[t>>2])};case 8:return function(t){return this.fromWireType((h(),Z)[t>>3])};default:throw new TypeError(`invalid float width (${r}): ${e}`)}},Tn=(e,r,t)=>{r=W(r),D(e,{name:r,fromWireType:n=>n,toWireType:(n,a)=>a,readValueFromPointer:bn(r,t),destructorFunction:null})},wn=(e,r,t,n,a)=>{r=W(r);const l=n===0;let u=f=>f;if(l){var c=32-8*t;u=f=>f<<c>>>c,a=u(a)}D(e,{name:r,fromWireType:u,toWireType:(f,p)=>p,readValueFromPointer:$r(r,t,n!==0),destructorFunction:null})},An=(e,r,t)=>{var n=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array,BigInt64Array,BigUint64Array],a=n[r];function l(u){var c=(h(),S)[u>>2],f=(h(),S)[u+4>>2];return new a((h(),N).buffer,f,c)}t=W(t),D(e,{name:t,fromWireType:l,readValueFromPointer:l},{ignoreDuplicateRegistrations:!0})},$n=(e,r,t,n)=>{if(!(n>0))return 0;for(var a=t,l=t+n-1,u=0;u<e.length;++u){var c=e.codePointAt(u);if(c<=127){if(t>=l)break;r[t++]=c}else if(c<=2047){if(t+1>=l)break;r[t++]=192|c>>6,r[t++]=128|c&63}else if(c<=65535){if(t+2>=l)break;r[t++]=224|c>>12,r[t++]=128|c>>6&63,r[t++]=128|c&63}else{if(t+3>=l)break;r[t++]=240|c>>18,r[t++]=128|c>>12&63,r[t++]=128|c>>6&63,r[t++]=128|c&63,u++}}return r[t]=0,t-a},Or=(e,r,t)=>$n(e,(h(),k),r,t),Ir=e=>{for(var r=0,t=0;t<e.length;++t){var n=e.charCodeAt(t);n<=127?r++:n<=2047?r+=2:n>=55296&&n<=57343?(r+=4,++t):r+=3}return r},Pn=(e,r)=>{r=W(r),D(e,{name:r,fromWireType(t){var n=(h(),S)[t>>2],a=t+4,l;return l=ue(a,n,!0),G(t),l},toWireType(t,n){n instanceof ArrayBuffer&&(n=new Uint8Array(n));var a,l=typeof n=="string";l||ArrayBuffer.isView(n)&&n.BYTES_PER_ELEMENT==1||m("Cannot pass non-string to std::string"),l?a=Ir(n):a=n.length;var u=qe(4+a+1),c=u+4;return(h(),S)[u>>2]=a,l?Or(n,c,a+1):(h(),k).set(n,c),t!==null&&t.push(G,u),u},readValueFromPointer:Fe,destructorFunction(t){G(t)}})},Cn=new TextDecoder("utf-16le"),Sn=(e,r,t)=>{var n=e>>1,a=Ne((h(),Y),n,r/2,t);return Cn.decode((h(),Y).slice(n,a))},En=(e,r,t)=>{if(t??=2147483647,t<2)return 0;t-=2;for(var n=r,a=t<e.length*2?t/2:e.length,l=0;l<a;++l){var u=e.charCodeAt(l);(h(),X)[r>>1]=u,r+=2}return(h(),X)[r>>1]=0,r-n},Rn=e=>e.length*2,Fn=(e,r,t)=>{for(var n="",a=e>>2,l=0;!(l>=r/4);l++){var u=(h(),S)[a+l];if(!u&&!t)break;n+=String.fromCodePoint(u)}return n},kn=(e,r,t)=>{if(t??=2147483647,t<4)return 0;for(var n=r,a=n+t-4,l=0;l<e.length;++l){var u=e.codePointAt(l);if(u>65535&&l++,(h(),V)[r>>2]=u,r+=4,r+4>a)break}return(h(),V)[r>>2]=0,r-n},xn=e=>{for(var r=0,t=0;t<e.length;++t){var n=e.codePointAt(t);n>65535&&t++,r+=4}return r},Mn=(e,r,t)=>{t=W(t);var n,a,l;r===2?(n=Sn,a=En,l=Rn):(n=Fn,a=kn,l=xn),D(e,{name:t,fromWireType:u=>{var c=(h(),S)[u>>2],f=n(u+4,c*r,!0);return G(u),f},toWireType:(u,c)=>{typeof c!="string"&&m(`Cannot pass non-string to C++ string type ${t}`);var f=l(c),p=qe(4+f+r);return(h(),S)[p>>2]=f/r,a(c,p+4,f+r),u!==null&&u.push(G,p),p},readValueFromPointer:Fe,destructorFunction(u){G(u)}})},Wn=(e,r)=>{r=W(r),D(e,{isVoid:!0,name:r,fromWireType:()=>{},toWireType:(t,n)=>{}})},Un=e=>{Je(e,!T,1,!1,65536,!1),y.threadInitTLS()},Xe=e=>{e()},Ln=!Atomics.waitAsync||globalThis.navigator?.userAgent&&Number((navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)||[])[2])<91,Ye=e=>{if(!Ln){var r=Atomics.waitAsync((h(),V),e>>2,e);r.value.then(We);var t=e+128;Atomics.store((h(),V),t>>2,1)}},We=()=>Xe(()=>{var e=Ke();e&&(Ye(e),tt())}),On=(e,r)=>{if(e==r)setTimeout(We);else if(g)postMessage({targetThread:e,cmd:"checkMailbox"});else{var t=y.pthreads[e];if(!t)return;t.postMessage({cmd:"checkMailbox"})}},Ue=[],In=(e,r,t,n,a)=>{n/=2,Ue.length=n;for(var l=a>>3,u=0;u<n;u++)(h(),H)[l+2*u]?Ue[u]=(h(),H)[l+2*u+1]:Ue[u]=(h(),Z)[l+2*u+1];var c=oi[e];y.currentProxiedOperationCallerThread=t;var f=c(...Ue);return y.currentProxiedOperationCallerThread=0,f},Hn=()=>{},Dn=e=>{g?postMessage({cmd:"cleanupThread",thread:e}):Pe(e)},Bn=e=>{},Nn=()=>{throw 1/0},de={},Hr=()=>performance.timeOrigin+performance.now();function Dr(e,r){if(g)return M(6,0,1,e,r);if(de[e]&&(clearTimeout(de[e].id),delete de[e]),!r)return 0;var t=setTimeout(()=>{delete de[e],Xe(()=>rt(e,Hr()))},r);return de[e]={id:t,timeout_ms:r},0}var Vn=()=>Date.now(),jn=9007199254740992,zn=-9007199254740992,Gn=e=>e<zn||e>jn?NaN:Number(e),Xn=()=>{},Yn=e=>_(ue(e)),Zn=()=>{throw"unwind"},Br=()=>2147483648,qn=()=>Br(),Kn=()=>navigator.hardwareConcurrency,Jn=(e,r)=>Math.ceil(e/r)*r,Qn=e=>{var r=I.buffer.byteLength,t=(e-r+65535)/65536|0;try{return I.grow(t),q(),1}catch{}},ei=e=>{var r=(h(),k).length;if(e>>>=0,e<=r)return!1;var t=Br();if(e>t)return!1;for(var n=1;n<=4;n*=2){var a=r*(1+.2/n);a=Math.min(a,e+100663296);var l=Math.min(t,Jn(Math.max(e,a),65536)),u=Qn(l);if(u)return!0}return!1},Ze={},ri=()=>"./this.program",_e=()=>{if(!_e.strings){var e=(globalThis.navigator?.language??"C").replace("-","_")+".UTF-8",r={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:e,_:ri()};for(var t in Ze)Ze[t]===void 0?delete r[t]:r[t]=Ze[t];var n=[];for(var t in r)n.push(`${t}=${r[t]}`);_e.strings=n}return _e.strings};function Nr(e,r){if(g)return M(7,0,1,e,r);var t=0,n=0;for(var a of _e()){var l=r+t;(h(),S)[e+n>>2]=l,t+=Or(a,l,1/0)+1,n+=4}return 0}function Vr(e,r){if(g)return M(8,0,1,e,r);var t=_e();(h(),S)[e>>2]=t.length;var n=0;for(var a of t)n+=Ir(a)+1;return(h(),S)[r>>2]=n,0}function jr(e){return g?M(9,0,1,e):52}function zr(e,r,t,n){return g?M(10,0,1,e,r,t,n):52}function Gr(e,r,t,n){return g?M(11,0,1,e,r,t,n):(r=Gn(r),70)}var ti=[null,[],[]],ni=(e,r=0,t,n)=>{var a=Ne(e,r,t,n);return pr.decode(e.buffer?e.buffer instanceof ArrayBuffer?e.subarray(r,a):e.slice(r,a):new Uint8Array(e.slice(r,a)))},ii=(e,r)=>{var t=ti[e];r===0||r===10?((e===1?d:_)(ni(t)),t.length=0):t.push(r)};function Xr(e,r,t,n){if(g)return M(12,0,1,e,r,t,n);for(var a=0,l=0;l<t;l++){var u=(h(),S)[r>>2],c=(h(),S)[r+4>>2];r+=8;for(var f=0;f<c;f++)ii(e,(h(),k)[u+f]);a+=c}return(h(),S)[n>>2]=a,0}var ai=()=>e=>e.set(crypto.getRandomValues(new Uint8Array(e.byteLength))),Yr=e=>{(Yr=ai())(e)},si=(e,r)=>(Yr((h(),k).subarray(e,e+r)),0);y.init(),Gt(),on();var oi=[Be,yr,br,Tr,wr,Ar,Dr,Nr,Vr,jr,zr,Gr,Xr],qe,G,Zr,qr,Ke,Je,Kr,Jr,Qr,et,rt,tt,Le,nt,it,at,st,ot;function li(e){s.__ZdlPvm=e.Z,qe=s._malloc=e._,G=e.$,s._calloc=e.aa,Zr=e.ba,qr=e.ca,Ke=e.da,s._emscripten_builtin_free=e.ea,e.fa,Je=e.ha,Kr=e.ia,s.___libc_free=e.ja,s._emscripten_builtin_malloc=e.ka,s.___libc_malloc=e.la,Jr=e.ma,Qr=e.na,et=e.oa,rt=e.pa,tt=e.qa,s.__ZdaPv=e.ra,s.__ZdaPvm=e.sa,s.__ZdlPv=e.ta,s.__Znaj=e.ua,s.__ZnajSt11align_val_t=e.va,s.__Znwj=e.wa,s.__ZnwjSt11align_val_t=e.xa,s.___libc_calloc=e.ya,s.___libc_realloc=e.za,s._emscripten_builtin_calloc=e.Aa,s._emscripten_builtin_realloc=e.Ba,s._malloc_size=e.Ca,s._malloc_usable_size=e.Da,s._reallocf=e.Ea,Le=e.Fa,nt=e.Ga,it=e.Ha,at=e.Ia,st=e.Ja,ot=e.ga}var lt;function ui(){lt={b:It,K:mr,p:br,J:Tr,T:wr,q:Ar,F:Dt,s:Nt,u:Vt,k:fn,U:dn,d:vn,c:gn,X:mn,r:Tn,g:wn,e:An,t:Pn,l:Mn,v:Wn,O:Un,G:On,L:In,B:Hn,n:Dn,N:Ye,W:Bn,z:Nn,C:Dr,o:Xn,f:Vn,m:Yn,V:Zn,H:qn,h:Hr,I:Kn,D:ei,P:Nr,Q:Vr,i:Ut,j:jr,S:zr,M:Gr,R:Xr,y:ci,w:hi,x:fi,a:I,A:Be,E:si}}function ci(e,r,t){var n=Ce();try{return le(e)(r,t)}catch(a){if(oe(n),a!==a+0)throw a;Le(1,0)}}function fi(e,r,t,n,a){var l=Ce();try{return le(e)(r,t,n,a)}catch(u){if(oe(l),u!==u+0)throw u;Le(1,0)}}function hi(e,r,t,n){var a=Ce();try{return le(e)(r,t,n)}catch(l){if(oe(a),l!==l+0)throw l;Le(1,0)}}function di(e){Ae=!0,y.tlsInitFunctions.push(e.fa),!g&&e.Y()}var ut;function ct(){ui();var e={a:lt};WebAssembly.instantiateStreaming(fetch("jassub-worker.wasm"),e).then(r=>{var t=(r.instance||r).exports;ut=r.module||s.wasm,li(t),xt(Mt),di(t),y.loadWasmModuleToAllWorkers().then(v)})}return g||ct(),Ae?i=s:i=new Promise((e,r)=>{w=e}),i}var $t=globalThis.self?.name?.startsWith("em-pthread");$t&&or();const lr=(o,i=!1)=>{const s=new XMLHttpRequest;return s.open("GET",o,!1),s.responseType=i?"arraybuffer":"text",s.send(null),s.response},Pt=(o,i,s)=>{const d=new XMLHttpRequest;d.open("GET",o,!0),d.responseType="arraybuffer",d.onload=()=>{if((d.status===200||d.status===0)&&d.response)return i(d.response)},d.onerror=s,d.send(null)},He="BT601",ur="BT709",cr="SMPTE240M",fr="FCC",hr=[null,He,null,He,He,ur,ur,cr,cr,fr,fr];function Te(o,i){for(const s of Object.keys(o))i[s]=o[s]}const Ct=!!WebAssembly.Memory.prototype.toResizableBuffer,we=new Float32Array([1,0,0,0,1,0,0,0,1]),St={BT601:{BT709:new Float32Array([1.0863,.0965,-.01411,-.0723,.8451,-.0277,-.0141,.0584,1.0418]),BT601:we},BT709:{BT601:new Float32Array([.9137,.0784,.0079,-.1049,1.1722,-.0671,.0096,.0322,.9582]),BT709:we},FCC:{BT709:new Float32Array([1.0873,-.0736,-.0137,.0974,.8494,.0531,-.0127,-.0251,1.0378]),BT601:new Float32Array([1.001,-8e-4,-2e-4,9e-4,1.005,-.006,.0013,.0027,.996])},SMPTE240M:{BT709:new Float32Array([.9993,6e-4,1e-4,-4e-4,.9812,.0192,-.0034,-.0114,1.0148]),BT601:new Float32Array([.913,.0774,.0096,-.1051,1.1508,-.0456,.0063,.0207,.973])}},Et=`#version 300 es
precision highp float;

const vec2 QUAD_POSITIONS[6] = vec2[6](
  vec2(0.0, 0.0),
  vec2(1.0, 0.0),
  vec2(0.0, 1.0),
  vec2(1.0, 0.0),
  vec2(1.0, 1.0),
  vec2(0.0, 1.0)
);

uniform vec2 u_resolution;
uniform vec4 u_destRect;  // x, y, w, h
uniform vec4 u_color;     // r, g, b, a
uniform float u_texLayer;

flat out vec2 v_destXY;
flat out vec4 v_color;
flat out vec2 v_texSize;
flat out float v_texLayer;

void main() {
  vec2 quadPos = QUAD_POSITIONS[gl_VertexID];
  vec2 pixelPos = u_destRect.xy + quadPos * u_destRect.zw;
  vec2 clipPos = (pixelPos / u_resolution) * 2.0 - 1.0;
  clipPos.y = -clipPos.y;

  gl_Position = vec4(clipPos, 0.0, 1.0);
  v_destXY = u_destRect.xy;
  v_color = u_color;
  v_texSize = u_destRect.zw;
  v_texLayer = u_texLayer;
}
`,Rt=`#version 300 es
precision highp float;
precision highp sampler2DArray;

uniform sampler2DArray u_texArray;
uniform mat3 u_colorMatrix;
uniform vec2 u_resolution;

flat in vec2 v_destXY;
flat in vec4 v_color;
flat in vec2 v_texSize;
flat in float v_texLayer;

out vec4 fragColor;

void main() {
  // Flip Y: WebGL's gl_FragCoord.y is 0 at bottom, but destXY.y is from top
  vec2 fragPos = vec2(gl_FragCoord.x, u_resolution.y - gl_FragCoord.y);

  // Calculate local position within the quad (screen coords)
  vec2 localPos = fragPos - v_destXY;

  // Convert to integer texel coordinates for texelFetch
  ivec2 texCoord = ivec2(floor(localPos));

  // Bounds check (prevents out-of-bounds access)
  ivec2 texSizeI = ivec2(v_texSize);
  if (texCoord.x < 0 || texCoord.y < 0 || texCoord.x >= texSizeI.x || texCoord.y >= texSizeI.y) {
    fragColor = vec4(0.0);
    return;
  }

  // texelFetch: integer coords, no interpolation, no precision issues
  float mask = texelFetch(u_texArray, ivec3(texCoord, int(v_texLayer)), 0).r;

  // Apply color matrix conversion (identity if no conversion needed)
  vec3 correctedColor = u_colorMatrix * v_color.rgb;

  // libass color alpha: 0 = opaque, 255 = transparent (inverted)
  float colorAlpha = 1.0 - v_color.a;

  // Final alpha = colorAlpha * mask
  float a = colorAlpha * mask;

  // Premultiplied alpha output
  fragColor = vec4(correctedColor * a, a);
}
`,dr=64,_r=256;class Ft{gl=null;program=null;vao=null;u_resolution=null;u_destRect=null;u_color=null;u_texArray=null;u_colorMatrix=null;u_texLayer=null;texArray=null;texArrayWidth=0;texArrayHeight=0;colorMatrix=we;setCanvas(i,s,d){if(!(s<=0||d<=0)){if(i.width=s,i.height=d,!this.gl){if(this.gl=i.getContext("webgl2",{alpha:!0,premultipliedAlpha:!0,antialias:!1,depth:!1,stencil:!1,desynchronized:!0}),!this.gl)throw new Error("Could not get WebGL2 context");const _=this.createShader(this.gl.VERTEX_SHADER,Et),v=this.createShader(this.gl.FRAGMENT_SHADER,Rt);if(!_||!v)throw new Error("Failed to create shaders");if(this.program=this.gl.createProgram(),this.gl.attachShader(this.program,_),this.gl.attachShader(this.program,v),this.gl.linkProgram(this.program),!this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS)){const T=this.gl.getProgramInfoLog(this.program);throw new Error("Failed to link program: "+T)}this.gl.deleteShader(_),this.gl.deleteShader(v),this.u_resolution=this.gl.getUniformLocation(this.program,"u_resolution"),this.u_destRect=this.gl.getUniformLocation(this.program,"u_destRect"),this.u_color=this.gl.getUniformLocation(this.program,"u_color"),this.u_texArray=this.gl.getUniformLocation(this.program,"u_texArray"),this.u_colorMatrix=this.gl.getUniformLocation(this.program,"u_colorMatrix"),this.u_texLayer=this.gl.getUniformLocation(this.program,"u_texLayer"),this.vao=this.gl.createVertexArray(),this.gl.bindVertexArray(this.vao),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.useProgram(this.program),this.gl.uniform1i(this.u_texArray,0),this.gl.uniformMatrix3fv(this.u_colorMatrix,!1,this.colorMatrix),this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,1),this.gl.clearColor(0,0,0,0),this.gl.activeTexture(this.gl.TEXTURE0),this.createTexArray(_r,_r)}this.gl.viewport(0,0,s,d),this.gl.uniform2f(this.u_resolution,s,d)}}createShader(i,s){const d=this.gl.createShader(i);if(this.gl.shaderSource(d,s),this.gl.compileShader(d),!this.gl.getShaderParameter(d,this.gl.COMPILE_STATUS)){const _=this.gl.getShaderInfoLog(d);return console.log(_),this.gl.deleteShader(d),null}return d}setColorMatrix(i,s){this.colorMatrix=(i&&s&&St[i]?.[s])??we,this.gl&&this.u_colorMatrix&&this.program&&(this.gl.useProgram(this.program),this.gl.uniformMatrix3fv(this.u_colorMatrix,!1,this.colorMatrix))}createTexArray(i,s){this.texArray&&this.gl.deleteTexture(this.texArray),this.texArray=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,this.texArray),this.gl.texImage3D(this.gl.TEXTURE_2D_ARRAY,0,this.gl.R8,i,s,dr,0,this.gl.RED,this.gl.UNSIGNED_BYTE,null),this.gl.texParameteri(this.gl.TEXTURE_2D_ARRAY,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D_ARRAY,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D_ARRAY,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D_ARRAY,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.texArrayWidth=i,this.texArrayHeight=s}render(i,s){if(!this.gl||!this.program||!this.vao||!this.texArray)return;(self.HEAPU8RAW.buffer!==self.WASMMEMORY.buffer||Ct)&&(s=self.HEAPU8RAW=new Uint8Array(self.WASMMEMORY.buffer)),this.gl.clear(this.gl.COLOR_BUFFER_BIT);let d=this.texArrayWidth,_=this.texArrayHeight;for(const v of i)v.w>d&&(d=v.w),v.h>_&&(_=v.h);(d>this.texArrayWidth||_>this.texArrayHeight)&&(this.createTexArray(d,_),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,this.texArray));for(let v=0,T=0;v<i.length;v++){const g=i[v];if(g.w<=0||g.h<=0)continue;const A=T%dr;T++,this.gl.pixelStorei(this.gl.UNPACK_ROW_LENGTH,g.stride),this.gl.texSubImage3D(this.gl.TEXTURE_2D_ARRAY,0,0,0,A,g.w,g.h,1,this.gl.RED,this.gl.UNSIGNED_BYTE,s,g.bitmap),this.gl.pixelStorei(this.gl.UNPACK_ROW_LENGTH,0),this.gl.uniform4f(this.u_destRect,g.dst_x,g.dst_y,g.w,g.h),this.gl.uniform1f(this.u_texLayer,A),this.gl.uniform4f(this.u_color,(g.color>>>24&255)/255,(g.color>>>16&255)/255,(g.color>>>8&255)/255,(g.color&255)/255),this.gl.drawArrays(this.gl.TRIANGLES,0,6)}}destroy(){this.gl&&(this.texArray&&(this.gl.deleteTexture(this.texArray),this.texArray=null),this.vao&&(this.gl.deleteVertexArray(this.vao),this.vao=null),this.program&&(this.gl.deleteProgram(this.program),this.program=null),this.gl=null)}}class kt{_offCanvas;_wasm;_subtitleColorSpace;_videoColorSpace;_malloc;_gpurender=new Ft;debug=!1;useLocalFonts=!1;_availableFonts={};_fontMap={};_fontId=0;_ready;_getFont;constructor(i,s){this._availableFonts=i.availableFonts,this.debug=i.debug,this.useLocalFonts=i.useLocalFonts,this._getFont=s;const d=globalThis.fetch;globalThis.fetch=v=>d(i.wasmUrl);const _=async({data:v})=>{v.name==="offscreenCanvas"&&(this._offCanvas=v.ctrl,this._gpurender.setCanvas(this._offCanvas,this._offCanvas.width,this._offCanvas.height),removeEventListener("message",_))};addEventListener("message",_),this._ready=or({__url:i.wasmUrl}).then(async v=>{this._malloc=v._malloc;const T=i.fallbackFont.toLowerCase();this._wasm=new v.JASSUB(i.width,i.height,T),this._wasm.setThreads(self.crossOriginIsolated?Math.min(Math.max(1,navigator.hardwareConcurrency-2),8):1),T&&this._findAvailableFonts(T);const g=i.subContent??lr(i.subUrl);for(const A of i.fonts)this._asyncWrite(A);this._wasm.createTrackMem(g),this._processAvailableFonts(g),this._subtitleColorSpace=hr[this._wasm.trackColorSpace],(i.libassMemoryLimit>0||i.libassGlyphLimit>0)&&this._wasm.setMemoryLimits(i.libassGlyphLimit||0,i.libassMemoryLimit||0),this._checkColorSpace()})}ready(){return this._ready}addFont(i){this._asyncWrite(i)}createEvent(i){Te(i,this._wasm.getEvent(this._wasm.allocEvent()))}getEvents(){const i=[];for(let s=0;s<this._wasm.getEventCount();s++){const{Start:d,Duration:_,ReadOrder:v,Layer:T,Style:g,MarginL:A,MarginR:E,MarginV:h,Name:w,Text:C,Effect:B}=this._wasm.getEvent(s);i.push({Start:d,Duration:_,ReadOrder:v,Layer:T,Style:g,MarginL:A,MarginR:E,MarginV:h,Name:w,Text:C,Effect:B})}return i}setEvent(i,s){Te(i,this._wasm.getEvent(s))}removeEvent(i){this._wasm.removeEvent(i)}createStyle(i){const s=this._wasm.getStyle(this._wasm.allocStyle());return Te(i,s),s}getStyles(){const i=[];for(let s=0;s<this._wasm.getStyleCount();s++){const{Name:d,FontName:_,FontSize:v,PrimaryColour:T,SecondaryColour:g,OutlineColour:A,BackColour:E,Bold:h,Italic:w,Underline:C,StrikeOut:B,ScaleX:N,ScaleY:k,Spacing:X,Angle:Y,BorderStyle:V,Outline:S,Shadow:ae,Alignment:Z,MarginL:H,MarginR:se,MarginV:Ae,Encoding:q,treat_fontname_as_pattern:De,Blur:$e,Justify:Pe}=this._wasm.getStyle(s);i.push({Name:d,FontName:_,FontSize:v,PrimaryColour:T,SecondaryColour:g,OutlineColour:A,BackColour:E,Bold:h,Italic:w,Underline:C,StrikeOut:B,ScaleX:N,ScaleY:k,Spacing:X,Angle:Y,BorderStyle:V,Outline:S,Shadow:ae,Alignment:Z,MarginL:H,MarginR:se,MarginV:Ae,Encoding:q,treat_fontname_as_pattern:De,Blur:$e,Justify:Pe})}return i}setStyle(i,s){Te(i,this._wasm.getStyle(s))}removeStyle(i){this._wasm.removeStyle(i)}styleOverride(i){this._wasm.styleOverride(this.createStyle(i))}disableStyleOverride(){this._wasm.disableStyleOverride()}setDefaultFont(i){this._wasm.setDefaultFont(i)}setTrack(i){this._wasm.createTrackMem(i),this._processAvailableFonts(i),this._subtitleColorSpace=hr[this._wasm.trackColorSpace]}freeTrack(){this._wasm.removeTrack()}setTrackByUrl(i){this.setTrack(lr(i))}_checkColorSpace(){!this._subtitleColorSpace||!this._videoColorSpace||this._gpurender.setColorMatrix(this._subtitleColorSpace,this._videoColorSpace)}_findAvailableFonts(i){i=i.trim().toLowerCase(),i[0]==="@"&&(i=i.substring(1)),!this._fontMap[i]&&(this._fontMap[i]=!0,this._availableFonts[i]?this._asyncWrite(this._availableFonts[i]):this.useLocalFonts&&this._getFont(i))}_asyncWrite(i){typeof i=="string"?Pt(i,s=>{this._allocFont(new Uint8Array(s))},console.error):this._allocFont(i)}_allocFont(i){const s=this._malloc(i.byteLength);self.HEAPU8RAW.set(i,s),this._wasm.addFont("font-"+this._fontId++,s,i.byteLength),this._wasm.reloadFonts()}_processAvailableFonts(i){if(!this._availableFonts)return;for(const{FontName:_}of this.getStyles())this._findAvailableFonts(_);const s=/\\fn([^\\}]*?)[\\}]/g;let d;for(;(d=s.exec(i))!==null;)this._findAvailableFonts(d[1])}_canvas(i,s,d,_){this._offCanvas&&this._gpurender&&this._gpurender.setCanvas(this._offCanvas,i,s),this._wasm.resizeCanvas(i,s,d,_)}async[ne](){await this._ready,this._wasm.quitLibrary(),this._gpurender.destroy(),this._wasm=null,this._gpurender=null,this._availableFonts={}}_draw(i,s=!1){if(!this._offCanvas||!this._gpurender)return;const d=this._wasm.rawRender(i,Number(s));if(this._wasm.changed===0&&!s)return;const _=[];for(let v=d,T=0;T<this._wasm.count;v=v.next,++T)_.push({bitmap:v.bitmap,color:v.color,dst_x:v.dst_x,dst_y:v.dst_y,h:v.h,stride:v.stride,w:v.w});this._gpurender.render(_,self.HEAPU8RAW)}_setColorSpace(i){i!=="RGB"&&(this._videoColorSpace=i,this._checkColorSpace())}}self.name==="jassub-worker"&&At(kt)})();
